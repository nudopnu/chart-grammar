<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/nearley@2.20.1/lib/nearley.min.js"></script>
    <script src="https://unpkg.com/moo@0.5.2/moo.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../out/grammar.js"></script>
    <title>chart-parser</title>
</head>

<body style="max-width: 600px; margin: auto;">
    <canvas id="chart"></canvas>
    <textarea id="chart-parser" style="height: 400px; width: 100%;"></textarea>
    <script>
        const textArea = document.getElementById("chart-parser");
        const canvas = document.getElementById("chart");
        textArea.addEventListener("input", update);

        let chart
        function update() {
            const parser = new nearley.Parser(nearley.Grammar.fromCompiled(grammar));
            const result = parser.feed(textArea.value).results[0];
            const config = getConfig(result);
            if (chart) {
                // If the chart already exists, update its data and options
                chart.data = config.data;
                chart.options = config.options;
                chart.update(); // Refresh the chart with the new data and options
            } else {
                // If the chart doesn't exist yet, create a new one
                chart = new Chart(canvas, {
                    type: "bar", // Default to bar chart
                    data: config.data,
                    options: config.options
                });
            }
        }

        function getConfig(result) {
            console.log(result);

            const config = {
                data: {
                    datasets: []
                },
                options: {
                    scales: {}
                }
            };
            const stackMap = {};

            if (result.stack?.length > 0) {
                config.options.scales.x = { stacked: true };
                config.options.scales.y = { stacked: true };
                result.stack.forEach(stack => {
                    stack.datasets.forEach(name => {
                        stackMap[name] = stack.name;
                    });
                });
            }
            if (result.labels) {
                config.data.labels = result.labels;
            }
            if (result.title) {
                config.options.plugins = {
                    title: {
                        display: true,
                        text: result.title,
                    }
                };
            }
            if (result.bar) {
                result.bar.forEach(bar => {
                    const dataset = {
                        label: bar.name,
                        data: bar.dataset,
                        type: 'bar',
                        backgroundColor: getRandomColor(),
                    };
                    if (bar.name in stackMap) {
                        dataset.stack = stackMap[bar.name];
                    }
                    config.data.datasets.push(dataset);
                });
            }
            if (result.line) {
                result.line.forEach(line => {
                    const dataset = {
                        label: line.name,
                        data: line.dataset,
                        type: 'line',
                        borderColor: getRandomColor(),
                        borderWidth: 3,
                    };
                    if (line.name in stackMap) {
                        dataset.stack = stackMap[line.name];
                    }
                    config.data.datasets.push(dataset);
                });
            }
            return config;
        }

        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        textArea.value = `title "Sales Revenue"
labels [jan, feb, mar, apr, may, jun, jul, aug, sep, oct, nov, dec]
stack "Stack 0" ["Dataset 1", "Dataset 2"]
bar "Dataset 1" [5000, 6000, 7500, 8200, 9500, 10500, 11000, 10200, 9200, 8500, 7000, 6000]
bar "Dataset 2" [5000, 6000, 7500, 8200, 9500, 10500, 11000, 10200, 9200, 8500, 7000, 6000]
bar "Dataset 3" [5000, 6000, 7500, 8200, 9500, 10500, 11000, 10200, 9200, 8500, 7000, 6000]
line "Dataset 4" [5000, 6000, 7500, 8200, 9500, 10500, 11000, 10200, 9200, 8500, 7000, 6000]`;
        update();

    </script>
</body>

</html>